% screening (1 by 1 unfortunately)
%% Vehicle
%Sq999
% dirData = '20170905/20170905_Sq999_Vehicle';
% dirFile = '02_FlashesPre';
% dirFile = '03_FlashesPost0s';
% dirFile = '04_FlashesPost1min18s';
% dirFile = '05_FlashesPost2min43s';
% dirFile = '06_FlashesPost4min08s';
% dirFile = '07_FlashesPost5min32s';
% dirFile = '08_FlashesPost6min58s';
% dirFile = '09_FlashesPost8min24s';
% dirFile = '11_FlashesPost13min14s';
% dirFile = '12_FlashesPost15min32s';
% 
% 
% dirData = '20170907/20170907_Sq999_Vehicle';
% dirFile = '02_FlashesPre';
% dirFile = '03_FlashesPost0s';
% dirFile = '04_FlashesPost1min16s';
% dirFile = '05_FlashesPost2min42s';
% dirFile = '06_FlashesPost4min15s';
% dirFile = '07_FlashesPost5min41s';
% dirFile = '08_FlashesPost7min04s';
% dirFile = '09_FlashesPost8min35s';
% dirFile = '11_FlashesPost14min43s';
% dirFile = '12_FlashesPost16min00s';

%Sq1000
% dirData = '20170829/20170829_Sq1000_Veh';
% dirFile = '03_FlahesPre';
% dirFile = '04_FlahesPost0s';
% dirFile = '05_FlahesPost30s';
% dirFile = '06_FlahesPost1min30s';
% dirFile = '07_FlahesPost3min';
% dirFile = '08_FlahesPost5min';
% dirFile = '09_FlahesPost7min15s';
% % 
% dirData = '20170831/20170831_Sq1000_Vehicle';
% dirFile = '02_FlashesPre';
% dirFile = '03_FlashesPost0s';
% dirFile = '04_FlashesPost40s';
% dirFile = '05_FlashesPost1min30s';
% dirFile = '06_FlashesPost2min30s';
% dirFile = '07_FlashesPost3min30s';
% dirFile = '08_FlashesPost4min30s';
% dirFile = '09_FlashesPost5min30s';
% dirFile = '10_FlashesPost6min30s';
% dirFile = '11_FlashesPost7min30s';
% dirFile = '12_FlashesPost8min30s';

%Sq992
% dirData = '20170830/20170830_Sq992_Veh';
% dirFile = '02_FlashesPre';
% dirFile = '03_FlashesPost0s';
% dirFile = '04_FlashesPost1min10s';
% dirFile = '05_FlashesPost2min10s';
% dirFile = '06_FlashesPost3min5s';
% dirFile = '07_FlashesPost4min';
% dirFile = '08_FlashesPost5min10s';
% dirFile = '09_FlashesPost6min20s';
% dirFile = '10_FlashesPost7min40s';
% dirFile = '11_FlashesPost8min45s';
% % 
% % 
% dirData = '20170901/20170901_Squirrel992_Vehicle';
% dirFile = '02_FlashesPre';
% dirFile = '03_FlashesPost0s';
% dirFile = '04_FlashesPost1min20s';
% dirFile = '05_FlashesPost2min45s';
% dirFile = '06_FlashesPost4min15s';
% dirFile = '07_FlashesPost5min40s';
% dirFile = '08_FlashesPost7min06s';
% dirFile = '09_FlashesPost8min40s';
% dirFile = '11_FlashesPost13min50s';
%% MB001 High dose
% %Sq1040
% dirData = '20171023/20171023_Sq1040_MB001High';
% dirFile = '02_FlashesPre';
% dirFile = '03_FlashesPost0s';
% dirFile = '04_FlashesPost1min09s';
% dirFile = '05_FlashesPost2min38s';
% dirFile = '06_FlashesPost4min07s';
% dirFile = '07_FlashesPost5min35s';
% dirFile = '08_FlashesPost7min05s';
% dirFile = '09_FlashesPost8min34s';
% dirFile = '11_FlashesPost14min29s';
% dirFile = '12_FlashesPost16min12s';
% 
% dirData = '20171025/20171025_Sq1040_MB001High';
% dirFile = '02_FlashPre';
% dirFile = '03_FlashPost0s';
% dirFile = '04_FlashPost1min19s';
% dirFile = '05_FlashPost2min53s';
% dirFile = '06_FlashPost4min20s';
% dirFile = '07_FlashPost5min48s';
% dirFile = '08_FlashPost7min14s';
% dirFile = '09_FlashPost8min37s';
% dirFile = '11_FlashPost13min55s';
% dirFile = '12_FlashPost15min23s';

%Sq928
% dirData = '20170830/20170830_Sq928_MB001High';
% dirFile = '03_FlashesPre';
% dirFile = '04_FlashesPost0s';
% dirFile = '05_FlashesPost40s';
% dirFile = '06_FlashesPost2min';
% dirFile = '07_FlashesPost3min10s';
% dirFile = '08_FlashesPost4min30s';
% dirFile = '09_FlashesPost6min';
% dirFile = '10_FlashesPost7min20s';
% dirFile = '11_FlashesPost8min30s';
% % 
% dirData = '20170901/20170901_Squirrel928_MB001High';
% dirFile = '03_FlashesBrighterPre';

%Sq1006
% dirData = '20170829/20170829_Sq1006_MB001High';
% dirFile = '04_FlashesPre';
% dirFile = '05_FlashesPost0s';
% dirFile = '06_FlashesPost1min';
% dirFile = '07_FlashesPost2min20s';
% dirFile = '08_FlashesPost4min30s';
% dirFile = '09_FlashesPost6min30s';
% dirFile = '10_FlashesPost7min50s';
% % 
% % 
% dirData = '20170831/20170831_Sq1006_MB001High';
% dirFile = '02_FlashesPre';
% dirFile = '03_FlashesPost0s';
% dirFile = '04_FlashesPost40s';
% dirFile = '05_FlashesPost2min';
% dirFile = '06_FlashesPost2min55s';
% dirFile = '07_FlashesPost3min50s';
% dirFile = '08_FlashesPost4min50s';
% dirFile = '09_FlashesPost5min45s';
% dirFile = '10_FlashesPost6min43s';
% dirFile = '11_FlashesPost7min40s';
% dirFile = '12_FlashesPost8min40s';
% dirFile = '16_FlashesPost18min';
%% MB001 Low
%Sq993
% dirData = '20170829/20170829_Sq993_MB001Low';
% dirFile = '03_FlashesPre';
% dirFile = '04_FlashesPost0s';
% dirFile = '05_FlashesPost1min';
% dirFile = '06_FlashesPost2min30s';
% dirFile = '07_FlashesPost3min55s';
% dirFile = '08_FlashesPost5min';
% dirFile = '09_FlashesPost6min50s';
% dirFile = '10_FlashesPost8min';
% % 
% % 
% dirData = '20170831/20170831_Sq993_MB001Low';
% dirFile = '02_FlashesPre';
% dirFile = '03_FlashesPost0s';
% dirFile = '04_FlashesPost40s';
% dirFile = '05_FlashesPost1min30s';
% dirFile = '06_FlashesPost2min25s';
% dirFile = '07_FlashesPost3min30s';
% dirFile = '08_FlashesPost4min30s';
% dirFile = '09_FlashesPost5min28s';
% dirFile = '10_FlashesPost6min25s';
% dirFile = '11_FlashesPost7min27s';
% dirFile = '12_FlashesPost8min20s';
% dirFile = '13_FlashesPost9min20s';
% dirFile = '15_FlashesPost14min20s';

%Sq998
% dirData = '20170830/20170830_Sq998_MB001Low';
% dirFile = '02_FlashesPre';
% dirFile = '03_FlashesPost0s';
% dirFile = '04_FlashesPost40s';
% dirFile = '05_FlashesPost1min20s';
% dirFile = '06_FlashesPost2min30s';
% dirFile = '07_FlashesPost3min50s';
% dirFile = '08_FlashesPost4min55s';
% dirFile = '09_FlashesPost6min10s';
% dirFile = '10_FlashesPost7min30s';
% dirFile = '11_FlashesPost8min40s';
% % 
% % 
% dirData = '20170901/20170901_Squirrel998_MB001Low';
% dirFile = '02_FlashesPre';
% dirFile = '03_FlashesPost0s';
% dirFile = '04_FlashesPost1min17s';
% dirFile = '05_FlashesPost2min45s';
% dirFile = '06_FlashesPost4min06s';
% dirFile = '07_FlashesPost5min32s';
% dirFile = '08_FlashesPost6min57s';
% dirFile = '09_FlashesPost8min25s';
% dirFile = '11_FlashesPost13min50s';
% dirFile = '12_FlashesPost15min40s';
% dirFile = '13_FlashesPost17min0s';

%% Fenretinide
%Sq990
% dirData = '20170905/20170905_Sq990_Fenretinide';
% dirFile = '02_FlashesPre';
% dirFile = '03_FlashesPost0s';
% dirFile = '04_FlashesPost1min17s';
% dirFile = '05_FlashesPost2min40s';
% dirFile = '06_FlashesPost4min05s';
% dirFile = '07_FlashesPost5min36s';
% dirFile = '08_FlashesPost7min06s';
% dirFile = '09_FlashesPost8min28s';
% dirFile = '11_FlashesPost13min52s';
% dirFile = '12_FlashesPost15min52s';
% 
% 
% dirData = '20170907/20170907_Sq990_Fenretinide';
% dirFile = '02b_FlashesPre';
% dirFile = '03_FlashesPost0s';
% dirFile = '04_FlashesPost1min25s';
% dirFile = '05_FlashesPost2min50s';
% dirFile = '06_FlashesPost4min20s';
% dirFile = '07_FlashesPost5min45s';
% dirFile = '08_FlashesPost7min11s';
% dirFile = '09_FlashesPost8min41s';
% dirFile = '11_FlashesPost13min43s';
% dirFile = '12_FlashesPost15min12s';

%Sq995
% dirData = '20170905/20170905_Sq995_Fenretinide';
% dirFile = '02_FlashesPre';
% dirFile = '03_FlashesPost0s';
% dirFile = '04_FlashesPost1min23s';
% dirFile = '05_FlashesPost2min27s';
% dirFile = '06_FlashesPost4min16s';
% dirFile = '07_FlashesPost5min44s';
% dirFile = '08_FlashesPost7min08s';
% dirFile = '09_FlashesPost8min36s';
% dirFile = '11_FlashesPost13min47s';
% dirFile = '12_FlashesPost15min20s';
% % 
% dirData = '20170907/20170907_Sq995_Fenretinide';
% dirFile = '02_FlashesPre';
% dirFile = '03_FlashesPost0s';
% dirFile = '04_FlashesPost1min11s';
% dirFile = '05_FlashesPost2min37s';
% dirFile = '06_FlashesPost4min03s';
% dirFile = '07_FlashesPost5min28s';
% dirFile = '08_FlashesPost6min53s';
% dirFile = '09_FlashesPost8min20s';
% dirFile = '11_FlashesPost13min42s';
% dirFile = '12_FlashesPost15min10s';
% dirFile = '13_FlashesPost16min36s';


%Sq1090
dirData = '20171023/20171023_Sq1090_Fenretinide';
dirFile = '02_FlashesPre';
dirFile = '03_FlashesPost0s';
dirFile = '04_FlashesPost1min13s';
dirFile = '05_FlashesPost2min41s';
dirFile = '06_FlashesPost4min10s';
dirFile = '07_FlashesPost5min37s';
dirFile = '08_FlashesPost7min03s';
dirFile = '09_FlashesPost8min34s';
dirFile = '11_FlashesPost13min57s';
dirFile = '12_FlashesPost16min04s';
% 
dirData = '20171025/20171025_Sq1090_Fenretinide';
dirFile = '02_FlashesPre';
dirFile = '03_FlashPost0s';
dirFile = '04_FlashPost1min16s';
dirFile = '05_FlashPost2min43s';
dirFile = '06_FlashPost4min13s';
dirFile = '07_FlashPost5min36s';
dirFile = '08_FlashPost7min01s';
dirFile = '09_FlashPost8min32s';
dirFile = '11_FlashPost13min36s';
dirFile = '12_FlashPost15min05s';

erg=ERGobj(dirData,dirFile);
% %% first screen trials
hGUI=erg_screenrecovery(erg,[],10);
% set(hGUI.figH,'Position',[-1760 -43 1572 989])
% set(hGUI.figH,'Position',[0 100 900 989])
% set(hGUI.figH,'Position',[200 5 1169 800]) %1 screen

%% t delays
a=[...
    0,0;...
    0,0;...
    1,16;...
    2,43;...
    4,13;...
    5,36;...
    7,01;...
    8,32;...
    13,36;...
    15,05;...
];

% a=[...
%     0,0;...
%     0,0;...
%     0,40;...
%     1,30;...
%     2,30;...
%     3,30;...
%     4,30;...
%     5,30;...
%     6,30;...
%     7,30;...
%     8,30;...
% ];


    
tdelays=(a(:,1).*60+a(:,2))';
fprintf('[');fprintf('%g,',tdelays)
fprintf(']\n')



%% concatenator
% %MB001 High
whichone='Sq1006'; ttm = 'MB001 High dose';
% whichone='Sq1040'; ttm = 'MB001 High dose';
% % whichone='Sq928'; ttm = 'MB001 High dose'; %dead one
% % %MB001 Low
% whichone='Sq993'; ttm = 'MB001 Low dose';
% whichone='Sq998'; ttm = 'MB001 Low dose';
% % % %Fenretinide
% whichone='Sq990'; ttm = 'Fenretinide';
% whichone='Sq995'; ttm = 'Fenretinide';
% whichone='Sq1090'; ttm = 'Fenretinide';
% % % %Vehicle
% whichone='Sq999'; ttm = 'Vehicle';
% whichone='Sq1000'; ttm = 'Vehicle';
% whichone='Sq992'; ttm = 'Vehicle';
ergR=erg_recovery(whichone); title(sprintf('%s: %s',ttm,whichone));
xlim([-50 600]);
% ylim([1e-2 1e1]);
% ylim([0 1.2]);

%% Save all plots
whichone={...
    'Sq1006';...
    'Sq1040';...
    
    
    'Sq993';...
    'Sq998';...
    
    'Sq990';...
    'Sq995';...
    'Sq1090';...
    
    'Sq999';...
    'Sq1000';...
    'Sq992';...
};

figtitles={
    sprintf('MB001 High dose: %s','Sq1006');...
    sprintf('MB001 High dose: %s','Sq1040');...
    
    
    sprintf('MB001 Low dose: %s','Sq993');...
    sprintf('MB001 Low dose: %s','Sq998');...
    
     sprintf('Fenretinide: %s','Sq990');...
    sprintf('Fenretinide: %s','Sq995');...
    sprintf('Fenretinide: %s','Sq1090');...
    
    sprintf('Vehicle: %s','Sq999');...
    sprintf('Vehicle: %s','Sq1000');...
    sprintf('Vehicle: %s','Sq992');...
};

results.tau1=NaN(size(whichone));
results.tau3=NaN(size(whichone));
results.recFraction1=NaN(size(whichone));
results.recFraction3=NaN(size(whichone));

for i = 1:size(whichone,1)
    ergR=erg_recovery(whichone{i});
    title(figtitles{i});
    drawnow
    results.tau1(i)=ergR.d1fitcoeffs(3);
    results.tau3(i)=ergR.d3fitcoeffs(3);
    results.recFraction1(i)=mean(ergR.d1norm.ab(ergR.d1results.t>500&ergR.d1results.t<=600));
    if strcmpi(whichone(i),'Sq1000')
        results.recFraction1(i)=mean(ergR.d1norm.ab(ergR.d1results.t>400&ergR.d1results.t<=600));
    end
    results.recFraction3(i)=mean(ergR.d3norm.ab(ergR.d3results.t>500&ergR.d3results.t<=600));
%     makeAxisStruct(ergR.figData.fig,whichone{i},sprintf('erg/squirrel/invivo/round2/recovery'));
    makeAxisStruct(ergR.figData.fig,whichone{i},sprintf('erg/squirrel/invivo/round2/RecoveryUnNorm'));
end
%%
f2=getfigH(2);
set(f2,'YScale','linear')
setLabels(f2,'time constant day 1 (s)','time constant day 3 (s)')

lh=lineH([0 max(results.tau3)],[0 max(results.tau3)]*1.05,f2);
lh.linedash;
%Vehicles
i=[8,9,10];
lh=lineH(results.tau1(i),results.tau3(i),f2);
lh.markers;lh.color([.5 .5 .5]);lh.setName('Veh');
%Fenretinide
i=[5,6,7];
lh=lineH(results.tau1(i),results.tau3(i),f2);
lh.markers;lh.color([0 1 0]);lh.setName('Fen');
%MB001
i=[1,2];
lh=lineH(results.tau1(i),results.tau3(i),f2);
lh.markers;lh.color([1 0 0]);lh.setName('MB001High');
i=[3,4];
lh=lineH(results.tau1(i),results.tau3(i),f2);
lh.marker('^');lh.color([1 0 0]);lh.setName('MB001Low');

f3=getfigH(3);
set(f3,'YScale','linear')
setLabels(f3,'recovery fraction','recovery fraction')

lh=lineH([0 1.2],[0 1.2]*1.05,f3);
lh.linedash;
%Vehicles
i=[8,9,10];
lh=lineH(results.recFraction1(i),results.recFraction3(i),f3);
lh.markers;lh.color([.5 .5 .5]);lh.setName('Veh');
%Fenretinide
i=[5,6,7];
lh=lineH(results.recFraction1(i),results.recFraction3(i),f3);
lh.markers;lh.color([0 1 0]);lh.setName('Fen');
%MB001
i=[1,2];
lh=lineH(results.recFraction1(i),results.recFraction3(i),f3);
lh.markers;lh.color([1 0 0]);lh.setName('MB001High');
i=[3,4];
lh=lineH(results.recFraction1(i),results.recFraction3(i),f3);
lh.marker('^');lh.color([1 0 0]);lh.setName('MB001Low');
%% make recTable?

recTable=NaN(3,8);
%Vehicle
i=[8,9,10];
recTable(:,1)=round(results.tau1(i).*10)/10;
recTable(:,2)=round(results.tau3(i).*10)/10;
%MB001
i=[1,2];
recTable([1,2],3)=round(results.tau1(i).*10)/10;
recTable([1,2],4)=round(results.tau3(i).*10)/10;
i=[3,4];
recTable([1,2],5)=round(results.tau1(i).*10)/10;
recTable([1,2],6)=round(results.tau3(i).*10)/10;
%Fenretinide
i=[5,6,7];
recTable(:,7)=round(results.tau1(i).*10)/10;
recTable(:,8)=round(results.tau3(i).*10)/10;
